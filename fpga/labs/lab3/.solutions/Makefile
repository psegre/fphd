#############################################################################
##
## A first Makefile example to automate FPGA implementation and programming
## flows using Xilinx Vivado Tcl scripts.
##
## Command line usage:
##
##   % cp .solutions/Makefile .
##   % make clean
##   % make build
##   % make install
##
##
## Luca Pacher - pacher@to.infn.it
## Spring 2024
##
#############################################################################

## list of Verilog sources to be compiled
SOURCES := Gates.vhd tb_Gates.vhd

## top-level module (testbench)
TOP := tb_Gates

## some useful aliases
RM := rm -f -v
RMDIR := rm -rf -v


############################
##   simulation targets   ##
############################

## compile Verilog sources (xvlog)
compile: $(SOURCES)

	@xvhdl $(SOURCES) -log $@.log


## elaborate the design (xelab)
elaborate:

	@xelab -debug all $(TOP) -log $@.log


## run the simulation (xsim)
simulate: xsim.dir/work.$(TOP) run.tcl

	@echo "exec xsim -gui -tclbatch run.tcl work.$(TOP) -wdb $(TOP).wdb -log $@.log &" | tclsh -norc


## one-step compilation/elaboration/simulation
sim: compile elaborate simulate


## load waveforms into XSim GUI
waves: $(TOP).wdb

	@echo "exec xsim -gui $(TOP).wdb -nolog &" | tclsh -norc


################################
##   implementation targets   ##
################################

## run RTL to bitstream generation flows using a Project Mode Tcl script
.PHONY: build
build: build.tcl

	@vivado -mode batch -source build.tcl -notrace -log build.log -nojournal


## install bitstream to Arty board (Hardware Manager)
.PHONY: install
install: install.tcl

	@vivado -mode batch -source install.tcl -notrace -log install.log -nojournal


########################
##   cleanup target   ##
########################

## delete all log files and project files generated by Vivado flows
.PHONY: clean
clean:
 
	@$(RM) *.log *.jou *.str *.xpr *.xml *.bit *.bin
	@$(RMDIR) *.cache *.hbs *.hw *.ip_user_files *.runs *.sim *.srcs .Xil

